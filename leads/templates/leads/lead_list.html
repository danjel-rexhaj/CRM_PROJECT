{% extends "base.html" %}

{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>My Leads Page</title>

    <!-- Lidh CSS -->
    <link rel="stylesheet" href="{% static 'leads.admin.css' %}" />
</head>
<section class="text-gray-700 body-font">
    <div class="w-full px-5 py-24 mx-auto flex flex-wrap">
        <div class="w-full mb-6 py-6 flex justify-between items-center border-b border-gray-200">
            <div>
                <h2 class="leads_text">Leads</h2>
                {% if request.user.is_organisor %}
                <a class="text-gray-500 hover:text-blue-500" href="{% url 'leads:category-list' %}">
                    View categories
                </a>
                {% endif %}
            </div>
            {% if request.user.is_organisor %}
            <div>
                <a class="text-gray-500 hover:text-blue-500" href="{% url 'leads:lead-create' %}">
                    Create a new lead
                </a>
            </div>
            {% endif %}
        </div>
        <div class="forms-row">
            <!-- FORMA PeR FILTRIM / SEARCH (GET) -->
           <form method="get" class="filter-form">
    <div class="search-input-wrapper">
        <span class="search-icon">&#128269;</span>
        <input type="text" name="q" placeholder="Search..." value="{{ request.GET.q }}">
    </div>

    <select name="agent">
        <option value="">Te gjithe agjentet</option>
        {% for agent in agents %}
            <option value="{{ agent.id }}" {% if request.GET.agent == agent.id|stringformat:"s" %}selected{% endif %}>
                {{ agent.user.username }}
            </option>
        {% endfor %}
    </select>
    {% if user.is_organisor %}
    <select name="category">
        <option value="">Te gjitha kategorite</option>
        {% for cat in categories %}
            <option value="{{ cat.id }}" {% if request.GET.category == cat.id|stringformat:"s" %}selected{% endif %}>
                {{ cat.name }}
            </option>
        {% endfor %}
    </select>
 {% endif %}

    <div class="filter-actions">
        <button type="submit" class="filter-btn">Filtroni</button>
        {% if request.GET.q or request.GET.agent or request.GET.category %}
            <a href="{% url 'leads:lead-list' %}" class="reset-btn-global">&#10006;</a>
        {% endif %}
    </div>
</form>
            <!-- FORMA PeR ASSIGN AGENT (POST) -->
            {% if user.is_organisor %}
            <form method="POST" action="{% url 'leads:assign-multiple-agents' %}" class="assign-form">
                {% csrf_token %}
                <select id="agent-select" name="agent_id" required>
                    <option value="" disabled selected>Choose an agent</option>
                    {% for agent in agents %}
                        <option value="{{ agent.id }}">{{ agent.user.get_full_name }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="custom-blue-button">
                    Assign Agent
                </button>
            {% endif %}
        </div>
            <div class="flex flex-col w-full">
                <div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                    <div class="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8">
                        <div class="shadow overflow-hidden border-b border-gray-200 sm:rounded-lg">
                             <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                       <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        <label class="inline-flex items-center cursor-pointer space-x-4 select-none select-all-label">
                                        <input type="checkbox" id="select-all" class="form-checkbox h-4 w-4 text-blue-600" />
                                        <span>Select All</span>
                                        </label>
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        First Name
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Last Name
                                    </th>          
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Email
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Number
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Status
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Agent
                                    </th>
                                    <th scope="col" class="relative px-6 py-3">
                                        <span class="sr-only">Edit</span>
                                    </th>
                                </tr>
                                </thead>
                                <tbody>
                                    {% for lead in leads %}
                                        <tr class="bg-white">
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                <input type="checkbox" name="lead_ids" value="{{ lead.pk }}" class="lead-checkbox">
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                <a class="text-blue-500 hover:text-blue-800" href="{% url 'leads:lead-detail' lead.pk %}">{{ lead.first_name }}</a>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                {{ lead.last_name }}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                {{ lead.email }}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                {{ lead.phone_number }}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                {% if lead.category %}
                                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                                        {{ lead.category.name }}
                                                    </span>
                                                {% else %}
                                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                                        Unassigned
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                {% if lead.agent %}
                                                    {{ lead.agent.user.get_full_name }}
                                                {% else %}
                                                    No Agent
                                                {% endif %}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                <a href="{% url 'leads:lead-update' lead.pk %}" class="text-indigo-600 hover:text-indigo-900">
                                                    Edit
                                                </a>
                                            </td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="8" class="text-center text-gray-500 py-4">
                                                There are currently no leads
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const selectAllCheckbox = document.getElementById("select-all");
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener("change", function () {
            let checkboxes = document.querySelectorAll(".lead-checkbox");
            checkboxes.forEach(cb => cb.checked = this.checked);
        });
    }
});
</script>

{% endblock content %}
