
{% load static %}
<header class="text-gray-700 body-font">
  <link rel="stylesheet" href="{% static 'lead_detail.css' %}">
  <div class="container mx-auto flex flex-wrap p-5 flex-col md:flex-row items-center">
    <a href="{% url 'dashboard' %}" class="flex title-font font-medium items-center text-gray-900 mb-4 md:mb-0">
      <img src="{% static 'images/gjergj_white.png' %}" alt="Logo" class="w-10 h-10 mr-2">
      <span class="ml-3 text-xl">ALBOS CRM</span>
    </a>

    <nav class="md:ml-auto flex flex-wrap items-center text-base justify-center">
      {% if not request.user.is_authenticated %}
        <a href="{% url 'signup' %}" class="mr-5 hover:text-gray-900">Signup</a>
      {% else %}
        {% if request.user.is_organisor %}
          <a href="{% url 'agents:agent-list' %}" class="mr-5 hover:text-gray-900">Agents</a>
        {% endif %}
        <a href="{% url 'leads:lead-list' %}" class="mr-5 hover:text-gray-900">Leads</a>
      {% endif %}
    </nav>

    <div class="flex items-center gap-3">
      <!-- Dark Mode Toggle -->
      <button id="darkModeToggle" class="p-2 rounded-full border border-gray-400 hover:bg-gray-200 transition">
        🌙
      </button>

      <!-- Notification Bell -->
  {% if request.user.is_authenticated %}
  <div class="relative">
    <button id="notificationBell" class="p-2 rounded-full border border-gray-400 hover:bg-gray-200 transition relative">
      🔔
      {% if unread_count > 0 %}
        <span id="notificationCount" class="absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full">
          {{ unread_count }}
        </span>
      {% endif %}
    </button>

    <div id="notificationDropdown"
     class="absolute right-0 mt-2 w-64 bg-white shadow-lg rounded hidden z-50">
  <div id="notifItems" class="notif-list">
    {% for notif in unread_notifications|slice:":5" %}
      <a href="{{ notif.url }}"
       class="notif-item block px-4 py-2 text-sm hover:bg-gray-100 {% if not notif.read %}font-bold{% endif %}"
       data-id="{{ notif.id }}">
        {{ notif.message|truncatechars:50 }}
      </a>
    {% empty %}
      <span class="block px-4 py-2 text-sm">Nuk ka notifikime</span>
    {% endfor %}
  </div>

  <!-- Footer i dropdown-it -->
<div class="notif-footer"> <button type="button" id="notifMarkAll" class="btn-ghost">Mark all read</button> <button type="button" id="notifClose" class="btn-ghost">Close</button> </div> </div>

  </div>
  <audio id="notifSound" src="{% static 'sounds/new-lead.mp3' %}" preload="auto"></audio>
{% endif %}

      {% if request.user.is_authenticated %}
        <span class="text-sm">Logged in as: {{ request.user.username }}</span>
        <form method="post" action="{% url 'logout' %}" class="inline ml-3">
          {% csrf_token %}
          <button type="submit" class="inline-flex items-center bg-gray-200 border-0 py-1 px-3 
          focus:outline-none hover:bg-gray-300 rounded text-base mt-4 md:mt-0">
            Logout
            <svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" 
            stroke-width="2" class="w-4 h-4 ml-1" viewBox="0 0 24 24">
              <path d="M5 12h14M12 5l7 7-7 7"></path>
            </svg>
          </button>
        </form>
      {% else %}
        <a href="{% url 'login' %}" class="inline-flex items-center bg-gray-200 border-0 py-1 px-3 
        focus:outline-none hover:bg-gray-300 rounded text-base mt-4 md:mt-0">
          Login
          <svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" 
          stroke-width="2" class="w-4 h-4 ml-1" viewBox="0 0 24 24">
            <path d="M5 12h14M12 5l7 7-7 7"></path>
          </svg>
        </a>
      {% endif %}
    </div>
  </div>
</header>

<script>
  const toggleBtn = document.getElementById("darkModeToggle");
  const body = document.body;

  // kontrollon ruajtjen në localStorage
  if (localStorage.getItem("theme") === "dark") {
    body.classList.add("dark");
    toggleBtn.textContent = "☀️";
  }

  toggleBtn.addEventListener("click", () => {
    body.classList.toggle("dark");
    if (body.classList.contains("dark")) {
      localStorage.setItem("theme", "dark");
      toggleBtn.textContent = "☀️";
    } else {
      localStorage.setItem("theme", "light");
      toggleBtn.textContent = "🌙";
    }
  });

document.addEventListener("DOMContentLoaded", function() {
  const bell = document.getElementById("notificationBell");
  const dropdown = document.getElementById("notificationDropdown");
  const countBadge = document.getElementById("notificationCount");

  if (!bell || !dropdown) return;

  bell.addEventListener("click", function(e) {
    e.preventDefault();
    dropdown.classList.toggle("hidden");
    if (countBadge) countBadge.style.display = "none";
  });

  document.addEventListener("click", function(e) {
    if (!bell.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.classList.add("hidden");
    }
  });
});



(function(){
  const bell      = document.getElementById("notificationBell");
  const dropdown  = document.getElementById("notificationDropdown");
  const countBadge= document.getElementById("notificationCount");
  const notifSound= document.getElementById("notifSound");

  if (!bell || !dropdown) return;

  // --- CSRF helper (Django) ---
  function getCookie(name){
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
  }
  const csrftoken = getCookie('csrftoken');

  // --- Badge ---
  function updateBadge(n){
    if (n > 0){
      if (countBadge){
        countBadge.textContent = String(n);
        countBadge.style.display = 'flex';
      } else {
        const s = document.createElement('span');
        s.id = 'notificationCount';
        s.className = 'absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full';
        s.textContent = String(n);
        bell.appendChild(s);
      }
    } else if (countBadge){
      countBadge.style.display = 'none';
    }
  }

  // --- Rifresko vetëm LISTËN (jo footer-in) ---
  function renderList(items){
    let list = dropdown.querySelector('.notif-list');
    if (!list){
      // skeleton nëse s’egziston
      dropdown.innerHTML = `
        <div id="notifItems" class="notif-list"></div>
        <div class="notif-footer">
          <button type="button" id="notifMarkAll" class="btn-ghost">Mark all read</button>
          <button type="button" id="notifClose"   class="btn-ghost">Close</button>
        </div>`;
      list = dropdown.querySelector('.notif-list');
    }
    list.innerHTML = (!items || !items.length)
      ? `<span class="notif-empty">Nuk ka notifikime</span>`
      : items.map(i => `
          <a href="${i.url || '#'}" data-id="${i.id}" class="notif-item">
            ${(i.message||'').length > 120 ? (i.message||'').slice(0,117) + '…' : (i.message||'')}
          </a>
        `).join('');
  }

  // --- Shëno si lexuar ato që duken ---
  function markVisibleAsRead(){
    const ids = Array.from(dropdown.querySelectorAll('.notif-item')).map(a => a.dataset.id);
    if (!ids.length) { updateBadge(0); return; }
    fetch(`{% url "leads:notifications-mark-read" %}`, {
      method: 'POST',
      headers: {'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken': csrftoken || ''},
      body: new URLSearchParams(ids.map(id => ['ids[]', id]))
    }).then(() => updateBadge(0));
  }

  // --- Mark all read (butoni) ---
  function markAllRead(){
    fetch(`{% url "leads:notifications-mark-read" %}`, {
      method: 'POST',
      headers: {'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken': csrftoken || ''},
      body: 'all=true'
    }).then(() => {
      updateBadge(0);
      renderList([]);       // boshatis vetëm listën; footer-i mbetet → Close punon
    });
  }

  // --- Delegim klikimesh brenda dropdown-it (funksionon edhe pas render-imit) ---
  dropdown.addEventListener('click', (e) => {
    if (e.target.id === 'notifClose'){      // Close
      dropdown.classList.add('hidden');
      return;
    }
    if (e.target.id === 'notifMarkAll'){    // Mark all
      markAllRead();
      return;
    }
    if (e.target.closest('.notif-item')){   // Klik mbi një njoftim
      dropdown.classList.add('hidden');
    }
  });

  // --- Toggle me zilen (vetëm një handler) ---
  bell.addEventListener('click', (e) => {
    e.preventDefault();
    dropdown.classList.toggle('hidden');
    if (!dropdown.classList.contains('hidden')) {
      markVisibleAsRead();
    }
  });

  // --- Mbyll kur klikon jashtë / ESC ---
  document.addEventListener('click', (e) => {
    if (!dropdown.contains(e.target) && !bell.contains(e.target)) {
      dropdown.classList.add('hidden');
    }
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') dropdown.classList.add('hidden');
  });

  // --- Polling ---
  let lastCheck = new Date(Date.now() - 30 * 1000).toISOString();
  async function poll(){
    try{
      const res  = await fetch(`{% url "leads:notifications-feed" %}?since=${encodeURIComponent(lastCheck)}`, { credentials: 'same-origin' });
      const data = await res.json();
      if (data.items && data.items.length){
        try { notifSound && notifSound.play().catch(()=>{}); } catch(_){}
        renderList(data.items);
        updateBadge(data.items.length);
      }
      if (data.server_time) lastCheck = data.server_time;
    } catch(_) {
      // optional: console.error(_)
    } finally {
      setTimeout(poll, 12000);
    }
  }
  poll();
})();
</script>
